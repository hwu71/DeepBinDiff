FROM ubuntu:12.04 as claws-mail-3.8.1-cve-2012-4507-common
ARG nproc=1

RUN sed -i -re 's/([a-z]{2}\.)?archive.ubuntu.com|security.ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list

RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
    build-essential \
    autoconf \
    python \
    libtool \
    pkg-config \
    flex \
    bison \
    libetpan-dev \
    libglib2.0-dev \
    libgtk2.0-dev
    



# configure the freetype
ADD claws-mail-3.8.1.tar.bz2 /
WORKDIR /claws-mail-3.8.1
RUN ./configure

#############
## unpatched
FROM claws-mail-3.8.1-cve-2012-4507-common as claws-mail-3.8.1-cve-2012-4507
ARG nproc=1
RUN make -j $nproc 
RUN make install

CMD (mkdir -p /build/original/) && cp /claws-mail-3.8.1/src/claws-mail /build/original/

#############
## patched
FROM claws-mail-3.8.1-cve-2012-4507-common as claws-mail-3.8.1-cve-2012-4507-patched
ARG nproc=1

ADD patches /
RUN patch /claws-mail-3.8.1/src/procmime.c /procmime.c.diff

RUN make -v -j $nproc 
RUN make install
CMD (mkdir -p /build/patched) && cp  /claws-mail-3.8.1/src/claws-mail /build/patched/

